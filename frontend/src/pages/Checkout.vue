<template>
  <div class="checkout-page">
    <Header />
    <main class="container">
      <div class="breadcrumbs">
        <span class="brand">VietMarket</span>
        <span class="separator">></span>
        <span class="link" @click="$router.push('/cart')">Gi·ªè h√†ng</span>
        <span class="separator">></span>
        <span class="current">Thanh to√°n</span>
      </div>

      <div class="checkout-content">
        <div class="checkout-form">
          <div class="form-section">
            <h2>ƒê·ªãa ch·ªâ giao h√†ng</h2>
            <div class="form-group">
              <label>H·ªç v√† t√™n <span class="required">*</span></label>
              <input 
                v-model="shippingInfo.fullName" 
                type="text" 
                placeholder="Nh·∫≠p h·ªç v√† t√™n"
                class="form-control"
              />
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>S·ªë ƒëi·ªán tho·∫°i <span class="required">*</span></label>
                <input 
                  v-model="shippingInfo.phone" 
                  type="tel" 
                  placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i"
                  class="form-control"
                />
              </div>
              
              <div class="form-group">
                <label>Email</label>
                <input 
                  v-model="shippingInfo.email" 
                  type="email" 
                  placeholder="Nh·∫≠p email"
                  class="form-control"
                />
              </div>
            </div>

            <div class="form-group">
              <label>ƒê·ªãa ch·ªâ <span class="required">*</span></label>
              <input 
                v-model="shippingInfo.address" 
                type="text" 
                placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng"
                class="form-control"
              />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>T·ªânh/Th√†nh ph·ªë <span class="required">*</span></label>
                <select v-model="shippingInfo.province" class="form-control">
                  <option value="">Ch·ªçn T·ªânh/Th√†nh ph·ªë</option>
                  <option value="H·ªì Ch√≠ Minh">TP. H·ªì Ch√≠ Minh</option>
                  <option value="H√† N·ªôi">H√† N·ªôi</option>
                  <option value="ƒê√† N·∫µng">ƒê√† N·∫µng</option>
                  <option value="C·∫ßn Th∆°">C·∫ßn Th∆°</option>
                </select>
              </div>

              <div class="form-group">
                <label>Qu·∫≠n/Huy·ªán <span class="required">*</span></label>
                <select v-model="shippingInfo.district" class="form-control">
                  <option value="">Ch·ªçn Qu·∫≠n/Huy·ªán</option>
                  <option value="Qu·∫≠n 1">Qu·∫≠n 1</option>
                  <option value="Qu·∫≠n 2">Qu·∫≠n 2</option>
                  <option value="Qu·∫≠n 3">Qu·∫≠n 3</option>
                </select>
              </div>

              <div class="form-group">
                <label>Ph∆∞·ªùng/X√£ <span class="required">*</span></label>
                <select v-model="shippingInfo.ward" class="form-control">
                  <option value="">Ch·ªçn Ph∆∞·ªùng/X√£</option>
                  <option value="Ph∆∞·ªùng B·∫øn Ngh√©">Ph∆∞·ªùng B·∫øn Ngh√©</option>
                  <option value="Ph∆∞·ªùng B·∫øn Th√†nh">Ph∆∞·ªùng B·∫øn Th√†nh</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label>Ghi ch√∫ ƒë∆°n h√†ng</label>
              <textarea 
                v-model="shippingInfo.note" 
                placeholder="Ghi ch√∫ v·ªÅ ƒë∆°n h√†ng, v√≠ d·ª•: th·ªùi gian hay ch·ªâ d·∫´n ƒë·ªãa ƒëi·ªÉm giao h√†ng chi ti·∫øt h∆°n"
                class="form-control"
                rows="3"
              ></textarea>
            </div>
          </div>

          <div class="form-section">
            <h2>Ph∆∞∆°ng th·ª©c thanh to√°n</h2>
            <div class="payment-methods">
              <label class="payment-option">
                <input 
                  type="radio" 
                  v-model="paymentMethod" 
                  value="cod" 
                  name="payment"
                />
                <div class="payment-content">
                  <div class="payment-icon">üíµ</div>
                  <div class="payment-details">
                    <strong>Thanh to√°n khi nh·∫≠n h√†ng (COD)</strong>
                    <p>Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng</p>
                  </div>
                </div>
              </label>

              <label class="payment-option">
                <input 
                  type="radio" 
                  v-model="paymentMethod" 
                  value="transfer" 
                  name="payment"
                />
                <div class="payment-content">
                  <div class="payment-icon">üè¶</div>
                  <div class="payment-details">
                    <strong>Chuy·ªÉn kho·∫£n ng√¢n h√†ng</strong>
                    <p>Chuy·ªÉn kho·∫£n qua ng√¢n h√†ng ho·∫∑c v√≠ ƒëi·ªán t·ª≠</p>
                  </div>
                </div>
              </label>

              <label class="payment-option">
                <input 
                  type="radio" 
                  v-model="paymentMethod" 
                  value="card" 
                  name="payment"
                />
                <div class="payment-content">
                  <div class="payment-icon">üí≥</div>
                  <div class="payment-details">
                    <strong>Th·∫ª t√≠n d·ª•ng/Ghi n·ª£</strong>
                    <p>Visa, Mastercard, JCB</p>
                  </div>
                </div>
              </label>
            </div>
          </div>
        </div>

        <div class="order-summary-section">
          <div class="summary-card">
            <h2>ƒê∆°n h√†ng c·ªßa b·∫°n</h2>
            
            <div class="order-items">
              <div v-if="checkoutItems.length === 0" class="empty-msg">ƒêang t·∫£i s·∫£n ph·∫©m...</div>
              <div v-else v-for="item in checkoutItems" :key="item.id" class="order-item">
                <img :src="getImageUrl(item.image)" :alt="item.name" class="order-item-image" @error="handleImageError" />
                <div class="order-item-info">
                  <h4>{{ item.name }}</h4>
                  <p>{{ item.seller?.name || 'Shop VietMarket' }}</p>
                  <div class="order-item-price">
                    <span class="quantity">x{{ item.quantity }}</span>
                    <span class="price">{{ formatPrice(calculateItemTotal(item)) }}</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="summary-divider"></div>

            <div class="summary-row">
              <span>T·∫°m t√≠nh ({{ totalQuantity }} s·∫£n ph·∫©m):</span>
              <span class="amount">{{ formatPrice(subtotal) }}</span>
            </div>

            <div class="summary-row">
              <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
              <span class="amount">{{ shippingFee === 0 ? 'Mi·ªÖn ph√≠' : formatPrice(shippingFee) }}</span>
            </div>

            <div class="summary-row discount" v-if="discount > 0">
              <span>Gi·∫£m gi√°:</span>
              <span class="amount">-{{ formatPrice(discount) }}</span>
            </div>

            <div class="summary-divider"></div>

            <div class="summary-row total">
              <span>T·ªïng c·ªông:</span>
              <span class="amount total-amount">{{ formatPrice(total) }}</span>
            </div>

            <button 
              class="btn-place-order" 
              @click="handlePlaceOrder"
              :disabled="!isFormValid || isProcessing || checkoutItems.length === 0"
            >
              <span v-if="isProcessing">ƒêang x·ª≠ l√Ω...</span>
              <span v-else>ƒê·∫∑t h√†ng</span>
            </button>

            <button class="btn-back-to-cart" @click="$router.push('/cart')">
              Quay l·∫°i gi·ªè h√†ng
            </button>
          </div>
        </div>
      </div>
    </main>
    <Footer />
  </div>
</template>

<script setup>
import { ref, computed, onMounted, watch } from 'vue';
import { useRouter, useRoute } from 'vue-router';
import { useCart } from '../stores/cart'; // ƒê·∫£m b·∫£o ƒë∆∞·ªùng d·∫´n ƒë√∫ng
import api from '../utils/api';
import { getImageUrl } from '../utils/imageUrl';
import { useToast } from '../utils/useToast';
import Header from '../components/layout/SearchHeader.vue';
import Footer from '../components/layout/AppFooter.vue';

const router = useRouter();
const route = useRoute();
const { cartItems, refreshCart, clearCart } = useCart();
const { showSuccess, showError } = useToast();

const isProcessing = ref(false);

// Shipping Info Form
const shippingInfo = ref({
  fullName: '',
  phone: '',
  email: '',
  address: '',
  province: '',
  district: '',
  ward: '',
  note: ''
});

const paymentMethod = ref('cod');

// === 1. LOGIC L·∫§Y S·∫¢N PH·∫®M CHECKOUT ===

// Refresh cart khi v√†o trang ƒë·ªÉ ƒë·∫£m b·∫£o d·ªØ li·ªáu m·ªõi nh·∫•t
onMounted(() => {
  refreshCart();
});

// Computed ƒë·ªÉ l·ªçc s·∫£n ph·∫©m d·ª±a tr√™n URL param ?items=1,2,3
const checkoutItems = computed(() => {
  if (!cartItems.value || cartItems.value.length === 0) return [];

  // N·∫øu c√≥ param items tr√™n URL
  if (route.query.items) {
    // Chuy·ªÉn chu·ªói "1,2,3" th√†nh m·∫£ng s·ªë [1, 2, 3]
    const selectedIds = route.query.items.split(',').map(id => parseInt(id));
    
    // L·ªçc cartItems c√≥ id n·∫±m trong danh s√°ch ƒë√£ ch·ªçn
    return cartItems.value.filter(item => selectedIds.includes(item.id));
  }
  
  // N·∫øu kh√¥ng c√≥ param items, tr·∫£ v·ªÅ r·ªóng (ho·∫∑c to√†n b·ªô cart t√πy logic b·∫°n mu·ªën)
  return []; 
});

// Theo d√µi checkoutItems, n·∫øu r·ªóng sau khi t·∫£i xong th√¨ b√°o l·ªói/redirect
watch(checkoutItems, (newItems) => {
  if (cartItems.value.length > 0 && newItems.length === 0) {
    // alert('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m thanh to√°n. Vui l√≤ng ch·ªçn l·∫°i t·ª´ gi·ªè h√†ng.');
    // router.push('/cart');
  }
});


// === 2. LOGIC T√çNH TI·ªÄN (QUAN TR·ªåNG) ===

// Helper: Chuy·ªÉn ƒë·ªïi gi√° an to√†n (X·ª≠ l√Ω c·∫£ s·ªë v√† chu·ªói)
const parsePrice = (price) => {
  if (typeof price === 'number') return price;
  if (typeof price === 'string') {
    // X√≥a t·∫•t c·∫£ k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
    return parseFloat(price.replace(/[^0-9]/g, '')) || 0;
  }
  return 0;
};

// Helper: Format hi·ªÉn th·ªã ti·ªÅn
const formatPrice = (price) => {
  const num = typeof price === 'number' ? price : parsePrice(price);
  return new Intl.NumberFormat('vi-VN').format(num) + ' ƒë';
};

// T·ªïng s·ªë l∆∞·ª£ng
const totalQuantity = computed(() => {
  return checkoutItems.value.reduce((sum, item) => sum + item.quantity, 0);
});

// T·ªïng ti·ªÅn h√†ng
const subtotal = computed(() => {
  return checkoutItems.value.reduce((total, item) => {
    return total + (parsePrice(item.price) * item.quantity);
  }, 0);
});

// Ph√≠ v·∫≠n chuy·ªÉn
const shippingFee = computed(() => {
  if (subtotal.value === 0) return 0;
  return subtotal.value > 500000 ? 0 : 30000;
});

const discount = ref(0);

// T·ªïng thanh to√°n cu·ªëi c√πng
const total = computed(() => {
  return subtotal.value + shippingFee.value - discount.value;
});

// T√≠nh ti·ªÅn t·ª´ng m√≥n (ƒë·ªÉ hi·ªÉn th·ªã)
const calculateItemTotal = (item) => {
  return parsePrice(item.price) * item.quantity;
};

const handleImageError = (e) => {
  e.target.src = "https://via.placeholder.com/80?text=No+Img";
};

// Validate form
const isFormValid = computed(() => {
  return shippingInfo.value.fullName && 
         shippingInfo.value.phone && 
         shippingInfo.value.address &&
         shippingInfo.value.province &&
         shippingInfo.value.district &&
         shippingInfo.value.ward &&
         paymentMethod.value;
});


// === 3. X·ª¨ L√ù ƒê·∫∂T H√ÄNG (G·ªåI API) ===
const handlePlaceOrder = async () => {
  if (!isFormValid.value) {
    showError('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin giao h√†ng!');
    return;
  }

  isProcessing.value = true;

  try {
    const paymentMethodMap = {
      'cod': 'cash',
      'transfer': 'bank_transfer',
      'card': 'credit_card'
    };

    // Chu·∫©n b·ªã payload g·ª≠i l√™n server
    const orderPayload = {
      receiver_name: shippingInfo.value.fullName,
      phone_number: shippingInfo.value.phone,
      street_address: shippingInfo.value.address,
      province: shippingInfo.value.province,
      district: shippingInfo.value.district,
      ward: shippingInfo.value.ward,
      payment_method: paymentMethodMap[paymentMethod.value] || 'cash',
      notes: shippingInfo.value.note || '',
      
      // Quan tr·ªçng: G·ª≠i danh s√°ch s·∫£n ph·∫©m ƒë·ªÉ Backend bi·∫øt ƒë∆°n h√†ng g·ªìm g√¨
      // (T√πy backend c·ªßa b·∫°n c√≥ y√™u c·∫ßu field n√†y kh√¥ng, nh∆∞ng th∆∞·ªùng l√† c√≥ n·∫øu API t·∫°o ƒë∆°n ƒë·ªôc l·∫≠p v·ªõi Cart)
      items: checkoutItems.value.map(item => ({
          product_id: item.id,
          quantity: item.quantity,
          price: parsePrice(item.price),
          variant_id: item.variant_id // N·∫øu c√≥ variant
      }))
    };

    console.log('Sending Order:', orderPayload);

    // G·ªçi API
    const response = await api.post('/orders', orderPayload);
    
    // N·∫øu th√†nh c√¥ng
    showSuccess('ƒê·∫∑t h√†ng th√†nh c√¥ng! ƒê∆°n h√†ng c·ªßa b·∫°n ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω.');
    
    // X√≥a gi·ªè h√†ng (Refresh l·∫°i t·ª´ server ƒë·ªÉ ƒë·ªìng b·ªô)
    await refreshCart(); 

    // Chuy·ªÉn h∆∞·ªõng
    router.push('/purchase-orders');

  } catch (error) {
    console.error('L·ªói ƒë·∫∑t h√†ng:', error);
    const msg = error.response?.data?.message || 'C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.';
    showError(msg);
  } finally {
    isProcessing.value = false;
  }
};
</script>

<style scoped>
/* CSS gi·ªØ nguy√™n nh∆∞ c≈© */
.checkout-page {
  background-color: #f8f9fa;
  min-height: 100vh;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px 15px;
}

.breadcrumbs {
  font-size: 14px;
  color: #007bff;
  margin-bottom: 20px;
  font-weight: 600;
}

.breadcrumbs .separator {
  margin: 0 5px;
  color: #777;
}

.breadcrumbs .link {
  cursor: pointer;
  transition: color 0.3s;
}

.breadcrumbs .link:hover {
  color: #0056b3;
  text-decoration: underline;
}

.breadcrumbs .current {
  color: #333;
}

.checkout-content {
  display: grid;
  grid-template-columns: 1fr 400px;
  gap: 20px;
  align-items: start;
}

@media (max-width: 992px) {
  .checkout-content {
    grid-template-columns: 1fr;
  }
}

/* Form Sections */
.checkout-form {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.form-section {
  background: white;
  padding: 24px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.form-section h2 {
  font-size: 1.5rem;
  margin: 0 0 20px 0;
  color: #333;
}

.form-group {
  margin-bottom: 20px;
  flex: 1;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #333;
  font-size: 0.95rem;
}

.required {
  color: #ff4444;
}

.form-control {
  width: 100%;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 1rem;
  transition: border-color 0.3s;
}

.form-control:focus {
  outline: none;
  border-color: #007bff;
}

.form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
}

textarea.form-control {
  resize: vertical;
  font-family: inherit;
}

/* Payment Methods */
.payment-methods {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.payment-option {
  display: flex;
  align-items: flex-start;
  padding: 15px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
}

.payment-option:hover {
  border-color: #007bff;
  background: #f8f9ff;
}

.payment-option input[type="radio"] {
  margin-top: 4px;
  margin-right: 15px;
  width: 20px;
  height: 20px;
  cursor: pointer;
}

.payment-option input[type="radio"]:checked + .payment-content {
  color: #007bff;
}

.payment-content {
  display: flex;
  gap: 15px;
  flex: 1;
}

.payment-icon {
  font-size: 2rem;
  line-height: 1;
}

.payment-details {
  flex: 1;
}

.payment-details strong {
  display: block;
  margin-bottom: 5px;
  font-size: 1rem;
}

.payment-details p {
  margin: 0;
  font-size: 0.9rem;
  color: #666;
}

/* Order Summary */
.order-summary-section {
  position: sticky;
  top: 20px;
}

.summary-card {
  background: white;
  padding: 24px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.summary-card h2 {
  font-size: 1.5rem;
  margin: 0 0 20px 0;
  color: #333;
}

.order-items {
  max-height: 300px;
  overflow-y: auto;
  margin-bottom: 20px;
}

.empty-msg {
  text-align: center;
  color: #888;
  font-style: italic;
  padding: 20px;
}

.order-item {
  display: flex;
  gap: 15px;
  padding: 15px 0;
  border-bottom: 1px solid #f0f0f0;
}

.order-item:last-child {
  border-bottom: none;
}

.order-item-image {
  width: 70px;
  height: 70px;
  object-fit: cover;
  border-radius: 6px;
  border: 1px solid #eee;
}

.order-item-info {
  flex: 1;
}

.order-item-info h4 {
  margin: 0 0 5px 0;
  font-size: 0.95rem;
  color: #333;
  line-height: 1.3;
}

.order-item-info p {
  margin: 0 0 8px 0;
  font-size: 0.85rem;
  color: #666;
}

.order-item-price {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.order-item-price .quantity {
  color: #666;
  font-size: 0.9rem;
  background: #f0f0f0;
  padding: 2px 8px;
  border-radius: 4px;
}

.order-item-price .price {
  font-weight: 700;
  color: #d70000;
}

.summary-divider {
  height: 1px;
  background: #e0e0e0;
  margin: 15px 0;
}

.summary-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 12px;
  font-size: 1rem;
  color: #555;
}

.summary-row.discount {
  color: #28a745;
}

.summary-row.total {
  font-size: 1.2rem;
  font-weight: 700;
  color: #333;
  margin-top: 10px;
}

.amount {
  font-weight: 600;
  color: #333;
}

.total-amount {
  font-size: 1.5rem;
  color: #d70000;
}

.btn-place-order {
  width: 100%;
  background: #ff6600;
  color: white;
  border: none;
  padding: 15px;
  border-radius: 6px;
  font-size: 1.1rem;
  font-weight: 700;
  cursor: pointer;
  transition: background 0.3s;
  margin-top: 20px;
}

.btn-place-order:hover:not(:disabled) {
  background: #e55a00;
}

.btn-place-order:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.btn-back-to-cart {
  width: 100%;
  background: white;
  color: #007bff;
  border: 2px solid #007bff;
  padding: 12px;
  border-radius: 6px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  margin-top: 10px;
}

.btn-back-to-cart:hover {
  background: #007bff;
  color: white;
}
</style>